name: Converted Workflow
on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
jobs:
  build:
    services:
      db:
        image: postgres:11
        ports: ['5432:5432']
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          POSTGRES_DB: travis_ci
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5433
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: anything
    env:
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: anything
      POSTGRES_DB: travis_ci
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5433
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: anything
      SECRET_KEY_BASE: development_secret
      COMMIT: ${GITHUB_SHA::8}
    runs-on: '${{ matrix.os }}'
    strategy:
      matrix:
        os:
          - ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0.4
          bundler-cache: true 
      - run: RAILS_ENV=test bundle exec rake db:create
      - run: RAILS_ENV=test bundle exec rake --trace db:migrate
      - run: bundle exec rake db:test:prepare
      - run: cp .env.sample .env
      - run: docker volume create --name=inkledb
      - run: docker-compose up -d || travis_terminate 1
      - run: docker-compose stop
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: albancrommer
          password: ${{ secrets.DOCKER_TOKEN }}      
      - run: |
          if [[ $GITHUB_REF_TYPE == "branch" ]]; then
            case "$GITHUB_REF_NAME" in  
              "master")
                TAG="latest"
                ;;
              "dev")
                TAG="dev"
                CD="stageme.inklewriter.com"
                ;;
            esac
          elif [[ $GITHUB_REF_TYPE == "tag" ]]; then 
            TAG="$GITHUB_REF_NAME"
          fi
          if [[ -n "$TAG" ]]; then
            echo "Pushing image to dockerhub"
            docker tag albancrommer/inklewriter albancrommer/inklewriter:${GITHUB_SHA::8};
            docker push albancrommer/inklewriter:${GITHUB_SHA::8};
            docker tag albancrommer/inklewriter albancrommer/inklewriter:$TAG;
            docker push albancrommer/inklewriter:$TAG;
          fi
          if [[ -n "$CD" ]]; then 
            URL="https://$CD/webhooks"
            echo "Requesting deployment for branch/tag '$GITHUB_REF_NAME' on '$URL'"
            curl -X POST -H "Content-Length: 0"  -H "Token: $CD_TOKEN" "$URL"
          fi
