name: Converted Workflow
on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
jobs:
  build:
    services:
      db:
        image: postgres:11
        ports: ['5432:5432']
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          POSTGRES_DB: travis_ci
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5433
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: anything
    env:
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: anything
      POSTGRES_DB: travis_ci
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5433
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: anything
      SECRET_KEY_BASE: development_secret
      COMMIT: ${GITHUB_SHA::8}
    runs-on: '${{ matrix.os }}'
    strategy:
      matrix:
        os:
          - ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0.4
          bundler-cache: true 
      - run: bundle install
      - run: RAILS_ENV=test bundle exec rake --trace db:migrate
      - run: bundle exec rake db:test:prepare
      - run: cp .env.sample .env
      - run: docker volume create --name=inkledb
      - run: docker-compose up -d || travis_terminate 1
      - run: docker-compose stop
      - run: |
          if [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; then
              echo "$DOCKER_PASS" | docker login -u=albancrommer --password-stdin;
              case "$TRAVIS_BRANCH" in  
                "master")
                  TAG="latest"
                  ;;
                "dev")
                  TAG="dev"
                  CD="stageme.inklewriter.com"
                  ;;
              esac
              if [[ -n "$TAG" ]]; then
                docker tag albancrommer/inklewriter albancrommer/inklewriter:$COMMIT;
                docker push albancrommer/inklewriter:$COMMIT;
                docker tag albancrommer/inklewriter albancrommer/inklewriter:$TAG;
                docker push albancrommer/inklewriter:$TAG;
              fi
              if [[ -n "$CD" ]]; then 
                URL="https://$CD/webhooks"
                echo "Requesting deployment for branch '$TRAVIS_BRANCH' on '$URL'"
                curl -X POST -H "Content-Length: 0"  -H "Token: $CD_TOKEN" "$URL"
              fi
          fi

